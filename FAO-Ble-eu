# FAOSTAT - Evolution des rendement de bl√© en Europe depuis 1961 jusqu'√† 2022

# Auteur : Lionel Elzear
# donn√©es : https://www.fao.org/faostat/fr/#data/QCL

#-------------------------------------------------------------------------------
# 1. rentrer les donn√©es : rendement de bl√© de 1961 √† 2022 
# 2. calculer le rendement en Qtx (Quintaux)
# 3. Graphique : Evolution de la production de bl√© en Europe
# 4. am√©lioration du graphique
# 5. faire un graphique par zone g√©ographique europ√©enne (Nord, Sud, Est, Ouest)
# 6. graphique interactif 
#-------------------------------------------------------------------------------

# Charger le package FAOSTAT
install.packages("FAOSTAT")
library(FAOSTAT)
library(data.table)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(ggrepel)
library(plotly)

#-------------------------------------------------------------------------------
# 1. rentrer les donn√©es : rendement de bl√© de 1961 √† 2022 
# Lire le fichier CSV en utilisant fread
FAO <- fread("CHEMIN DU FICHIER -> FAOSTAT-ble-EU.csv", quote = "\"")
# Afficher les premi√®res lignes du tableau
head(FAO)
# Nettoyer les guillemets doubles dans les colonnes n√©cessaires
colonnes_a_nettoyer <- c("Code ann√©e", "Ann√©e", "Valeur")
FAO[, (colonnes_a_nettoyer) := lapply(.SD, function(x) as.numeric(gsub("\"", "", x))), .SDcols = colonnes_a_nettoyer]
# Afficher les premi√®res lignes du tableau avec les colonnes converties
head(FAO)
# Conserver uniquement les colonnes n√©cessaires
FAO2 <- FAO[, .(Zone = Zone, Ann√©e = Ann√©e, Valeur = Valeur)]
# Afficher les premi√®res lignes du tableau avec les colonnes s√©lectionn√©es
head(FAO2)
#-------------------------------------------------------------------------------

# 2. calculer le rendement en Qtx (Quintaux)
# Diviser la colonne "Valeur" par 1000
FAO2$qt <- FAO2$Valeur / 1000
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# 3. Graphique : Evolution de la production de bl√© en Europe
# 3.1 Transformer la colonne "Zone" en facteur
FAO2$Zone <- as.factor(FAO2$Zone)

# 3.2 premier graphique üìâ tous les pays europ√©ens
# Cr√©er le graphique avec ggplot2
graphique <- ggplot(FAO2, aes(x = Ann√©e, y = qt, color = Zone)) +
  geom_line() +
  labs(title = "√âvolution de la production de bl√© (en quintaux)",
       x = "Ann√©e",
       y = "Production (quintaux)")

# Afficher le graphique
print(graphique)
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# 4. am√©lioration du graphique
# 4.1 Suppression des guillemets doubles de la colonne "Zone"
FAO2$Zone <- gsub("\"", "", FAO2$Zone)

# 4.2 Exclure la France et l'Allemagne
FAO3 <- subset(FAO2, Zone != "Allemagne" & Zone != "France") # grosses productions


# 4.3 Cr√©er le graphique avec ggplot2
graphique <- ggplot(FAO3, aes(x = Ann√©e, y = qt, color = Zone)) +
  geom_line() +
  labs(title = "√âvolution de la production de bl√© (en quintaux)",
       x = "Ann√©e",
       y = "Production (quintaux)")

# Afficher le graphique
print(graphique)
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# 5. faire un graphique par zone g√©ographique europ√©enne (Nord, Sud, Est, Ouest)

# 5.1 regarder les pays pr√©sent dans les donn√©es
FAO2$Zone
# Obtenir une liste unique des pays
liste_pays <- unique(FAO2$Zone)
# Afficher la liste compl√®te (attention, elle peut √™tre longue)
print(liste_pays)
#-------------------------------------------------------------------------------

# 5.2 A partir des donn√©es cr√©er des zones g√©ographiques 
# Ajouter la colonne Position bas√©e sur la colonne Zone
FAO2 <- FAO2 %>% mutate(Position = case_when(
  Zone %in% c("Allemagne", "Autriche", "Belgique", "Belgique-Luxembourg", "France", "Luxembourg", "Pays-Bas (Royaume des)") ~ "Ouest",
  Zone %in% c("Bulgarie","Hongrie",  "Pologne", "Roumanie", "Slovaquie", "Tch√©quie") ~ "Est",
  Zone %in% c("Danemark","Irlande", "Estonie", "Finlande", "Lettonie", "Lituanie", "Su√®de") ~ "Nord",
  Zone %in% c("Espagne","Chypre","Croatie", "Malte","Gr√®ce","Italie", "Portugal", "Slov√©nie") ~ "Sud",
  TRUE ~ "Autre"
))
#-------------------------------------------------------------------------------


#-------------------------------------------------------------------------------
# 5.3 cr√©er un premier graphique avec les zones g√©ographiques
# Cr√©er le graphique avec ggplot2 en utilisant la colonne Position
graphique <- ggplot(FAO2, aes(x = Ann√©e, y = qt, color = Zone)) +
  geom_line() +
  facet_wrap(~Position) +
  labs(title = "√âvolution de la production de bl√© (en quintaux) par groupe de pays",
       x = "Ann√©e",
       y = "Production (quintaux)")

# Afficher le graphique
print(graphique)
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
## 5.4 cr√©er un deuxi√®me graphique avec les zones g√©ographiques
# Cr√©er le dataframe pour les noms des pays √† afficher
pays_afficher <- FAO2 %>%
  group_by(Position, Zone) %>%
  filter(row_number() == 1) %>%
  ungroup()

# Cr√©er le graphique avec ggplot2 en utilisant la colonne Position
graphique <- ggplot(FAO2, aes(x = Ann√©e, y = qt, color = Zone, label = Zone)) +
  geom_line() +
  geom_text_repel(data = pays_afficher, aes(label = Zone), 
                  box.padding = 0.5, point.padding = 0.5, hjust = 1) +  # Centrer les noms
  facet_grid(Position ~ ., scales = "free_y", space = "free_y") +
  labs(title = "√âvolution de la production de bl√© (en quintaux) par groupe de pays",
       x = "Ann√©e",
       y = "Production (quintaux)",
       color = "Zone") +  # Ajouter une l√©gende pour la couleur (Zone)
  scale_color_discrete() +  # Utiliser une palette de couleurs de base
  guides(color = FALSE) +  # Supprimer la l√©gende des couleurs
  theme(legend.position = "none",      # Supprimer la l√©gende
        strip.text = element_text(size = 8, face = "bold", hjust = 1),  # Centrer le texte des facettes
        strip.background = element_blank(),  # Supprimer le fond des facettes
        panel.spacing = unit(2, "lines"))  # Ajuster l'espace entre les facettes

# Afficher le graphique
print(graphique)
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# 6. graphique interactif 
# Cr√©er le dataframe pour les noms des pays √† afficher
pays_afficher <- FAO2 %>%
  group_by(Position, Zone) %>%
  filter(row_number() == 1) %>%
  ungroup()

# Cr√©er le graphique interactif avec plotly
graphique_interactif <- ggplot(FAO2, aes(x = Ann√©e, y = qt, color = Zone, label = Zone)) +
  geom_line() +
  geom_text_repel(data = pays_afficher, aes(label = Zone), 
                  box.padding = 0.5, point.padding = 0.5, hjust = 0.5) +  # Centrer les noms
  facet_grid(Position ~ ., scales = "free_y", space = "free_y") +
  labs(title = "√âvolution de la production de bl√© (en quintaux) par groupe de pays",
       x = "Ann√©e",
       y = "Production (quintaux)",
       color = "Zone") +  # Ajouter une l√©gende pour la couleur (Zone)
  scale_color_discrete() +  # Utiliser une palette de couleurs de base
  theme(legend.position = "none",      # Supprimer la l√©gende
        strip.text = element_text(size = 8, face = "bold", hjust = 0.5),  # Centrer le texte des facettes
        strip.background = element_blank(),  # Supprimer le fond des facettes
        panel.spacing = unit(2, "lines"))  # Ajuster l'espace entre les facettes

# Convertir le graphique en plotly
graphique_interactif_plotly <- ggplotly(graphique_interactif)

# Afficher le graphique interactif
print(graphique_interactif_plotly)
# ------------------------------------------------------------------------------
